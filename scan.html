<!-- scan.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>抽選中…</title>
  <style>
    body { font-size:1.2rem; text-align:center; padding:1rem }
  </style>
</head>
<body>
  <p>抽選中です…少々お待ちください</p>

  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, set }
      from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // 1) Firebase コンソールからコピーした設定に置き換え
    const firebaseConfig = {
  apiKey: "AIzaSyAyLd3jvdVXikgOXrni3HwlDNUieeZAhH8",
  authDomain: "qryf-11545.firebaseapp.com",
  databaseURL: "https://qryf-11545-default-rtdb.firebaseio.com",
  projectId: "qryf-11545",
  storageBucket: "qryf-11545.firebasestorage.app",
  messagingSenderId: "539005507453",
  appId: "1:539005507453:web:9faf1d69b175a50ce41e14"
};

    // 2) Firebase 初期化
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // 3) URLパラメータから qrId と rank を取得
    const params = new URLSearchParams(location.search);
    const qrId   = params.get('id');
    const rank   = params.get('rank');
    if (!qrId || !rank) {
      document.body.innerHTML = '<p>❌ パラメータが不正です。</p>';
      throw new Error('Missing id or rank');
    }

    // 4) ユーザーID (uid) を localStorage から取得 or 新規発行
    let uid = localStorage.getItem('uid');
    if (!uid) {
      uid = crypto.randomUUID();
      localStorage.setItem('uid', uid);
    }

    // 5) Firebase に書き込み → 成功:結果ページへ / 失敗:「既に抽選済み」
    set(ref(db, `scans/${qrId}`), true)
      .then(() => set(ref(db, `users/${uid}`), true))
      .then(() => {
        // 抽選結果ページにリダイレクト
        location.replace(`result/${encodeURIComponent(rank)}.html`);
      })
      .catch(() => {
        // 二重スキャン等で書き込み拒否された場合
        document.body.innerHTML =
          '<p>※この QR は既に抽選済みです。</p>';
      });
  </script>
</body>
</html>
