<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æŠ½é¸ä¸­â€¦</title>
<style>
  body { font-size:1.2rem; text-align:center; padding:1rem; font-family:sans-serif }
  #msg b{font-size:1.4rem}
  #diag{opacity:.75; font-size:.9rem; margin-top:.5rem}
  button{padding:.6rem 1rem;border:0;border-radius:8px;background:#ff4081;color:#fff;margin-top:1rem}
</style>
<body>
  <p id="msg">æŠ½é¸ä¸­ã§ã™â€¦å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</p>
  <div id="diag"></div>
  <button id="retryBtn" style="display:none">ã‚‚ã†ä¸€åº¦</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    // --- Firebase è¨­å®šï¼ˆindex.html ã¨åŒã˜ã«ã™ã‚‹ï¼‰ ---
    const firebaseConfig = {
      apiKey: "AIzaSyAyLd3jvdVXikgOXrni3HwlDNUieeZAhH8",
      authDomain: "qryf-11545.firebaseapp.com",
      databaseURL: "https://qryf-11545-default-rtdb.firebaseio.com",
      projectId: "qryf-11545",
      storageBucket: "qryf-11545.firebasestorage.app",
      messagingSenderId: "539005507453",
      appId: "1:539005507453:web:9faf1d69b175a50ce41e14"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth();

    const params = new URLSearchParams(location.search);
    const qrId   = params.get('id');
    const rank   = params.get('rank') || '';
    const debug  = params.get('debug') === '1';

    const msg = document.getElementById('msg');
    const diag = document.getElementById('diag');
    const retryBtn = document.getElementById('retryBtn');
    retryBtn.onclick = ()=> location.reload();

    const showDiag = (lines)=>{ diag.innerHTML = Array.isArray(lines)? lines.map(l=>`<div>${l}</div>`).join('') : String(lines); };
    const goResult = ()=>{
      const to = new URL(`result/${encodeURIComponent(rank)}.html`, location.href);
      location.replace(to.href);
    };

    if (!qrId || !rank) {
      msg.innerHTML = '<b style="color:#c62828">ã‚¨ãƒ©ãƒ¼ï¼šURL ã« id ã¾ãŸã¯ rank ãŒã‚ã‚Šã¾ã›ã‚“</b>';
      showDiag(`URL: <code>${location.href.replace(/</g,'&lt;')}</code>`);
      retryBtn.style.display = 'inline-block';
      throw new Error('missing params');
    }

    // --- åŒ¿åèªè¨¼ï¼ˆBãƒ«ãƒ¼ãƒ«è¦ä»¶ï¼‰ ---
    signInAnonymously(auth).catch((e)=>{
      msg.innerHTML = '<b style="color:#c62828">èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ</b>';
      showDiag([`code: <code>${e.code||''}</code>`, `message: <code>${e.message||e}</code>`]);
      retryBtn.style.display = 'inline-block';
    });

    onAuthStateChanged(auth, async (user)=>{
      if (!user) return;
      if (debug) showDiag([`auth OK uid=<code>${user.uid}</code>`, `id=<code>${qrId}</code> rank=<code>${rank}</code>`]);

      try {
        const now = Date.now();
        // 1) å…ˆç€åˆ¶å¾¡: /scans/{qrId} ã‚’æ–°è¦ä½œæˆï¼ˆBãƒ«ãƒ¼ãƒ«: {uid, timestamp}ï¼‰
        await set(ref(db, `scans/${qrId}`), { uid: user.uid, timestamp: now });
        // 2) è‡ªåˆ†ã®æŠ½é¸æƒ…å ±: /users/{uid} ã« {drawnAt, qrId, rank}
        await set(ref(db, `users/${user.uid}`), { drawnAt: now, qrId: qrId, rank: rank });

        msg.innerHTML = `ğŸ‰ <b>${rank || 'å½“ãŸã‚Š'}</b> ãŒå‡ºã¾ã—ãŸï¼`;
        setTimeout(goResult, 500);
      } catch (e) {
        const code = e.code || '';
        if (String(code).includes('PERMISSION_DENIED')) {
          msg.innerHTML = '<b style="color:#c62828">ã“ã®QRã¯æ—¢ã«æŠ½é¸æ¸ˆã¿ã§ã™</b>';
          if (debug) showDiag([`code: <code>${code}</code>`, 'åŸå› å€™è£œ: å…ˆã«ä»–ç«¯æœ«ã§ç¢ºä¿ / ãƒ«ãƒ¼ãƒ«æœªæ•´åˆ']);
        } else {
          msg.innerHTML = '<b style="color:#c62828">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</b>';
          if (debug) showDiag([`code: <code>${code}</code>`, `message: <code>${e.message||e}</code>`]);
        }
        retryBtn.style.display = 'inline-block';
      }
    });
  </script>
</body>
</html>
