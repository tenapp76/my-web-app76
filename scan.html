<!-- scan.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>抽選中…</title>
  <style>
    body { font-size:1.2rem; text-align:center; padding:1rem }
  </style>
</head>
<body>
  <p>抽選中です…少々お待ちください</p>

  <!-- scan.html の <script type="module"> 部分をまるっと以下に置き換え -->
<script type="module">
import { initializeApp }
  from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, set, get }
  from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

// --- Firebase 設定 ---
const firebaseConfig = {
  apiKey: "…",
  authDomain: "…",
  databaseURL: "https://qryf-11545-default-rtdb.firebaseio.com",
  projectId: "…",
  storageBucket: "…",
  messagingSenderId: "…",
  appId: "…"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// --- パラメータ取得 ---
const params = new URLSearchParams(location.search);
const qrId   = params.get('id');
const rank   = params.get('rank');

// --- UID 処理 ---
let uid = localStorage.getItem('uid');
if (!uid) {
  uid = crypto.randomUUID();
  localStorage.setItem('uid', uid);
}

// --- デバッグ用ログ関数 ---
function showError(msg) {
  document.body.innerHTML = `<p style="color:red">⚠️ ${msg}</p>`;
  console.error(msg);
}

(async () => {
  try {
    console.log("▶ scan flow start", { qrId, rank, uid });

    if (!qrId || !rank) {
      throw new Error("Missing id or rank");
    }

    const userRef = ref(db, `users/${uid}`);
    const scanRef = ref(db, `scans/${qrId}`);

    console.log("→ checking user:", userRef.path.toString());
    const snapUser = await get(userRef);
    console.log("↳ snapUser.exists():", snapUser.exists());

    if (snapUser.exists()) {
      showError("※既に抽選済みです。");
      return;
    }

    console.log("→ writing scan record");
    await set(scanRef, true);

    console.log("→ writing user record");
    await set(userRef, true);

    console.log("→ redirecting to result page");
    location.replace(`result/${encodeURIComponent(rank)}.html`);

  } catch (err) {
    showError("エラーが発生しました: " + err.message);
  }
})();
</script>
</body>
</html>
