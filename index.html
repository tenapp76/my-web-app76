<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QRdeã¾ã¨ã‚ã¦æŠ½é¸</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ff4081" />

  <style>
    body {
      margin: 0; font-family: sans-serif;
      background: url('images/bg_setup.jpg') no-repeat center center fixed;
      background-size: cover; transition: background .5s ease;
    }
    body.playing {
      background: url('images/bg_play.jpg') no-repeat center center fixed;
      background-size: cover;
    }
    #setup {
      background: rgba(255,255,255,0.9);
      margin: 1rem auto; padding: 1rem;
      max-width: 600px; border-radius: 8px;
    }
    h2.title {
  font-size: 2.5rem;
  font-weight: 900;
  background: linear-gradient(45deg, #ff4081, #ff80ab);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;      /* ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã« */
  text-align: center;
  margin: 1rem 0;
  animation: shine 2s ease-in-out infinite alternate;
}
/* ã‚¿ã‚¤ãƒˆãƒ«ï¼‹å¹ãå‡ºã—ã‚’æ¨ªä¸¦ã³ã« */
.title-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;           /* ã‚¿ã‚¤ãƒˆãƒ«ã¨å¹ãå‡ºã—ã®é–“éš” */
  margin-bottom: 1rem;
}

/* å¹ãå‡ºã—æœ¬ä½“ */
.speech-bubble {
  position: relative;
  background: #fff;
  border: 2px solid #42a5f5;
  color: #333;
  padding: 0.3rem 0.8rem;
  border-radius: 8px;
  font-size: 0.7rem;
  white-space: nowrap;
}

/* å¹ãå‡ºã—ã®ã€Œã—ã£ã½ã€ */
.speech-bubble::after {
  content: "";
  position: absolute;
  top: 50%;
  left: -0.7rem;           /* æœ¬ä½“ã®å·¦ç«¯ã‹ã‚‰å°‘ã—ã¯ã¿å‡ºã™ */
  transform: translateY(-50%);
  width: 0; height: 0;
  border: 5px solid transparent;
  border-right-color: #42a5f5; /* æ ç·šã®è‰² */
}

/* å¹ãå‡ºã—å†…ã®èƒŒæ™¯è‰²ç”¨ã—ã£ã½ */
.speech-bubble::before {
  content: "";
  position: absolute;
  top: 50%;
  left: -0.3rem;
  transform: translateY(-50%);
  width: 0; height: 0;
  border: 3px solid transparent;
  border-right-color: #fff;    /* èƒŒæ™¯è‰²ã«åˆã‚ã›ã¦ */
}

@keyframes shine {
  from { text-shadow: 0 0 10px rgba(255,64,129,0.5); }
  to   { text-shadow: 0 0 20px rgba(255,64,129,1); }
}

    .instruction {
      background: #e3f2fd;
      border-left: 4px solid #42a5f5;
      padding: 0.75rem 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.95rem; color: #333;
    }
    label { display: block; margin: .5rem 0; }
    input[type=number], select { margin-left: .5rem; }
    .prob-setting {
      display: flex; align-items: center;
      background: #f0f0f0; padding: .5rem;
      margin-bottom: .5rem; border-radius: 6px;
    }
    .prob-setting .rank-label {
      width: 3em; font-weight: bold;
    }
    .prob-setting input[type=number] {
      width: 60px; margin: 0 .5rem;
    }
    .prob-setting input[type=file] {
      margin-left: .5rem;
    }
    .prob-setting .remove-btn {
      margin-left: auto; cursor: pointer;
      color: red; font-size: 1.2rem;
    }
    #countSum {
      font-weight: bold; margin: .5rem 0;
    }
    button {
      margin: 4px; padding: 8px 16px;
      border: none; border-radius: 6px;
      background: #ff4081; color: white; cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: default; }
    .qr {
      position: absolute; width: 60px; height: 60px;
      cursor: pointer; transition: opacity .3s;
    }
    @media(max-width:600px){
      .qr { width:50px; height:50px; }
      button { font-size:.9rem; }
    }
    canvas#confettiCanvas {
      position: fixed; top:0; left:0;
      pointer-events: none; z-index: 9999;
    }
    /* ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #logModal {
      display: none; position: fixed; top:0; left:0;
      width:100%; height:100%; background: rgba(0,0,0,0.6);
      justify-content: center; align-items: center; z-index:10000;
    }
    #logModal[aria-hidden="false"] { display: flex; }
    #logModal .modal-content {
      background: white; padding:1rem; border-radius:8px;
      max-width:90%; max-height:80%; overflow:auto;
    }
    #logTable {
      width:100%; border-collapse: collapse; margin-top:.5rem;
    }
    #logTable th, #logTable td {
      border:1px solid #ddd; padding:8px; text-align:center;
    }

    .warning {
      background: #ffebee;                /* è–„ã„èµ¤èƒŒæ™¯ */
      border-left: 4px solid #e53935;    /* èµ¤ã®ç›®ç«‹ã¤ãƒ©ã‚¤ãƒ³ */
      color: #b71c1c;                    /* ãƒ†ã‚­ã‚¹ãƒˆã‚‚èµ¤ç³» */
      padding: 0.75rem 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .warning strong {
      color: #b71c1c;
    }
  </style>

  <script>
    // PWA Service Workerç™»éŒ²
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .catch(() => console.warn('SWç™»éŒ²å¤±æ•—'));
      });
    }
  </script>
</head>

<body>
  <canvas id="confettiCanvas"></canvas>

  <!-- æŠ½é¸ãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="logModal" role="dialog" aria-modal="true"
       aria-labelledby="logModalTitle" aria-hidden="true" tabindex="-1">
    <div class="modal-content">
      <h2 id="logModalTitle">æŠ½é¸ãƒ­ã‚°</h2>
      <table id="logTable">
        <thead><tr><th>ç­‰ç´š</th><th>æ—¥æ™‚</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="text-align:right; margin-top:1rem;">
        <button id="exportCsvBtn">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button id="closeLogBtn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- è¨­å®šãƒ‘ãƒãƒ« -->
  <div id="setup">
    <div class="title-wrapper">
     <h2 class="title">QRdeã¾ã¨ã‚ã¦æŠ½é¸</h2>
     <span class="speech-bubble">æŠ½é¸ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã«ã©ã†ã</span>
    </div>

    <div class="instruction">
      â€» å„ç­‰ç´š(10ç­‰ã¾ã§)ã®æšæ•°ã®åˆè¨ˆã‚’QRã‚³ãƒ¼ãƒ‰æ•°ã¨ä¸€è‡´ã•ã›ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã€‚<br>
      â€» çµæœç”»åƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã¨ãªã‚Šã¾ã™ã€‚<br>
        ã€€ ã‚ªãƒªã‚¸ãƒŠãƒ«ã®çµæœç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚
    </div>

    <div class="warning">
       <strong>â€»ãŠé¡˜ã„ï¼š</strong>QRã‚³ãƒ¼ãƒ‰ã¯ä½•åº¦ã§ã‚‚èª­ã¿å–ã‚Œã¾ã™ãŒã€1äºº1å›ã®æŠ½é¸ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
    </div>

    <label for="qrTotal">QRã‚³ãƒ¼ãƒ‰æ•°(50å€‹ã¾ã§):
      <input type="number" id="qrTotal" value="10" min="1" max="50"
             oninput="updateSum()" required>
    </label>

    <label for="bgmSelect">BGMé¸æŠ:
      <select id="bgmSelect">
        <option value="off">ã‚ªãƒ•</option>
        <option value="pop">A</option>
        <option value="japan">B</option>
        <option value="fanfare">C</option>
      </select>
    </label>

    <div id="probSettings"></div>
    <button id="addProbBtn" onclick="addProb()">ç­‰ç´šã‚’è¿½åŠ </button>

    <div id="countSum">
      åˆè¨ˆæšæ•°: <span id="currentSum">0</span> / <span id="totalQR">0</span>
    </div>

    <button id="startBtn" onclick="startGame()" disabled>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="showLogBtn" onclick="showLog()">æŠ½é¸ãƒ­ã‚°ã‚’è¦‹ã‚‹</button>
  </div>

  <!-- BGM -->
  <audio id="bgm_pop"    src="data/bgm_pop.mp3" loop></audio>
  <audio id="bgm_japan"  src="data/bgm_japan.mp3" loop></audio>
  <audio id="bgm_fanfare"src="data/bgm_fanfare.mp3" loop></audio>

  <script>
    let qrData = [], qrElements = [], animationFrame, scanned = false;
    const canvas = document.getElementById('confettiCanvas');
    const ctx    = canvas.getContext('2d');
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
    let confetti  = [];

    function imageToBase64(file) {
      return new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload  = () => res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
    }

    function addProb() {
      const cont = document.getElementById('probSettings');
      const cnt  = cont.children.length;
      if (cnt >= 10) { alert('ç­‰ç´šã¯æœ€å¤§10ã¾ã§ã§ã™'); return; }
      const rank = cnt + 1;
      const div  = document.createElement('div');
      div.className = 'prob-setting';
      div.innerHTML = `
        <span class="rank-label">${rank}ç­‰</span>
        æšæ•°: <input name="count" type="number" value="1" min="1"
                   oninput="updateSum()" style="width:60px"> æš
        çµæœç”»åƒ: <input name="resultImage" type="file" accept="image/*">
        ${rank>1
          ? `<span class="remove-btn" role="button" tabindex="0"
                   onclick="removeProb(this)"
                   onkeydown="if(event.key==='Enter'||event.key===' ')removeProb(this)">
               âœ–
             </span>`
          : ``}
      `;
      cont.appendChild(div);
      updateSum();
    }

    function removeProb(btn) {
      btn.closest('.prob-setting').remove();
      document.querySelectorAll('.prob-setting').forEach((div,i)=>{
        div.querySelector('.rank-label').textContent = (i+1)+'ç­‰';
      });
      updateSum();
    }

    function updateSum() {
      const totalQR = +document.getElementById('qrTotal').value;
      const sum = [...document.querySelectorAll('input[name="count"]')]
        .map(i => +i.value).reduce((a,b)=>a+b,0);
      document.getElementById('currentSum').textContent = sum;
      document.getElementById('totalQR').textContent   = totalQR;
      document.getElementById('startBtn').disabled = (sum !== totalQR);
    }

    async function generateQRData() {
      const total = +document.getElementById('qrTotal').value;
      const groups = [...document.querySelectorAll('.prob-setting')];
      const counts = groups.map(div=>+div.querySelector('input[name="count"]').value);
      const sum    = counts.reduce((a,b)=>a+b,0);
      if (sum !== total) throw new Error('åˆè¨ˆæšæ•°ãŒ QRã‚³ãƒ¼ãƒ‰æ•°ã¨ä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“');
      const data=[]; let id=1;
      for (let i=0; i<groups.length; i++) {
        const cnt = counts[i];
        const fi  = groups[i].querySelector('input[name="resultImage"]');
   // å®Ÿéš›ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã¯ default_1ç­‰.png ã€œ default_10ç­‰.png
        const defaultImg = `images/default_${i+1}ç­‰.png`;
        const img = fi.files[0]
        ? await imageToBase64(fi.files[0])
        : defaultImg;
        for (let j=0; j<cnt; j++) {
      data.push({
        id: `qr${id++}`,
        image: `images/${i+1}ç­‰.png`,       // ãƒ­ãƒ¼ã‚«ãƒ«ã® QR ã‚³ãƒ¼ãƒ‰ç”»åƒã‚’å‚ç…§
        resultImage: img,
        rank: `${i+1}ç­‰`
      });
        }
      }
      return { data };
    }

    class QR {
      constructor(d) {
        this.d = d;
        this.el = document.createElement('img');
        this.el.src = d.image;
        this.el.className = 'qr';
        this.x = Math.random()*canvas.width;
        this.y = Math.random()*canvas.height;
        this.vx= Math.random()*3-1.5;
        this.vy= Math.random()*3-1.5;
        this.el.style.left = this.x+'px';
        this.el.style.top  = this.y+'px';
        this.el.onclick = ()=>this.click();
        document.body.appendChild(this.el);
      }
      move(){
        this.x+=this.vx; this.y+=this.vy;
        if(this.x<0||this.x>canvas.width-60) this.vx*=-1;
        if(this.y<0||this.y>canvas.height-60) this.vy*=-1;
        this.el.style.left=this.x+'px';
        this.el.style.top =this.y+'px';
      }
      click(){
        if(localStorage.getItem('hasDrawn')==='true'||scanned){
          alert('ğŸ‰ æŠ½é¸æ¸ˆã¿ã§ã™ ğŸ‰'); return;
        }
        scanned=true;
        localStorage.setItem('hasDrawn','true');
        this.destroy();
        logDraw(this.d.rank);
        localStorage.setItem('lastResultImage', this.d.resultImage);
        localStorage.setItem('lastRank', this.d.rank);
        window.open(`https://tenapp76.github.io/my-web-app76/result/${this.d.rank}.html`, '_blank');
      }
      destroy(){ this.el.remove(); }
    }

    function animate(){
      qrElements.forEach(q=>q.move());
      ctx.clearRect(0,0,canvas.width,canvas.height);
      confetti.forEach(c=>{
        c.x+=c.vx; c.y+=c.vy; c.vy+=.1;
        ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,2*Math.PI);
        ctx.fillStyle=c.color; ctx.fill();
      });
      confetti=confetti.filter(c=>c.y<canvas.height);
      animationFrame=requestAnimationFrame(animate);
    }

    async function startGame(){
      // ã‚²ãƒ¼ãƒ ä¸­ã¯ç­‰ç´šè¿½åŠ ã‚’ç„¡åŠ¹åŒ–
      document.getElementById('addProbBtn').disabled = true;
      document.body.classList.add('playing');
      document.getElementById('startBtn').disabled = true;
      const bgm = document.getElementById('bgmSelect').value;
      if(bgm!=='off') document.getElementById('bgm_'+bgm).play();
      try {
        const { data } = await generateQRData();
        qrData     = data;
        qrElements = qrData.map(d=>new QR(d));
        animate();
      } catch(e) {
        alert(e.message);
        resetGame();
      }
    }

    function resetGame(){
      // ãƒªã‚»ãƒƒãƒˆå¾Œã¯ç­‰ç´šè¿½åŠ ã‚’å†ã³æœ‰åŠ¹åŒ–
      document.getElementById('addProbBtn').disabled = false;
      cancelAnimationFrame(animationFrame);
      qrElements.forEach(q=>q.destroy());
      qrElements=[]; scanned=false;
      ['bgm_pop','bgm_japan','bgm_fanfare'].forEach(id=>{
        const a=document.getElementById(id); a.pause(); a.currentTime=0;
      });
      localStorage.removeItem('hasDrawn');
      localStorage.removeItem('lastResultImage');
      localStorage.removeItem('lastRank');
      localStorage.removeItem('qrLogs');
      document.getElementById('startBtn').disabled = false;
      document.body.classList.remove('playing');
    }

    function logDraw(rank){
      const logs = JSON.parse(localStorage.getItem('qrLogs')||'[]');
      logs.push({ rank, time:new Date().toLocaleString() });
      localStorage.setItem('qrLogs', JSON.stringify(logs));
    }

    function showLog(){
      const m=document.getElementById('logModal');
      const logs=JSON.parse(localStorage.getItem('qrLogs')||'[]');
      const tb=m.querySelector('tbody'); tb.innerHTML='';
      if(!logs.length){
        tb.innerHTML='<tr><td colspan="2">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      } else {
        logs.forEach(l=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${l.rank}</td><td>${l.time}</td>`;
          tb.appendChild(tr);
        });
      }
      m.setAttribute('aria-hidden','false');
      m.focus(); trapFocus(m);
    }

    function closeLog(){
      const m=document.getElementById('logModal');
      m.setAttribute('aria-hidden','true');
      document.getElementById('showLogBtn').focus();
    }

    function trapFocus(modal){
      const els=modal.querySelectorAll('button,[tabindex]:not([tabindex="-1"])');
      const first=els[0], last=els[els.length-1];
      modal.onkeydown=e=>{
        if(e.key==='Escape') return closeLog();
        if(e.key==='Tab'){
          if(e.shiftKey&&document.activeElement===first){
            e.preventDefault(); last.focus();
          } else if(!e.shiftKey&&document.activeElement===last){
            e.preventDefault(); first.focus();
          }
        }
      };
    }

    function downloadCsv(){
      const logs=JSON.parse(localStorage.getItem('qrLogs')||'[]');
      if(!logs.length) return alert('å±¥æ­´ãªã—');
      const rows=[['ç­‰ç´š','æ—¥æ™‚'], ...logs.map(l=>[l.rank,l.time])];
      const csv=rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\r\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='qr_logs.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    window.onload=()=>{
      addProb();
      updateSum();
      document.getElementById('closeLogBtn').onclick   = closeLog;
      document.getElementById('exportCsvBtn').onclick = downloadCsv;
    };
  </script>

  <footer style="
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 0.6rem;
    background: rgba(255, 255, 255, 0.7);
    padding: 4px 0;
  ">
    QRã‚³ãƒ¼ãƒ‰ã¯æ ªå¼ä¼šç¤¾ãƒ‡ãƒ³ã‚½ãƒ¼ã‚¦ã‚§ãƒ¼ãƒ–ã®ç™»éŒ²å•†æ¨™ã§ã™
  </footer>
</body>
</html>
