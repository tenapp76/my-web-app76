<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QRdeまとめて抽選</title>
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#ff4081"/>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;800&family=Outfit:wght@600;800&display=swap" rel="stylesheet">

  <!-- QRCode ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>

  <!-- PWA Service Worker（任意） -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('service-worker.js').catch(()=>console.warn('SW登録失敗'));
      });
    }
  </script>

  <style>
    :root{
      --bg:#0f1115; --card:rgba(255,255,255,0.9); --text:#1b1f24; --muted:#596575;
      --accent:#ff4d88; --accent-2:#7c4dff; --chip-bg:#eef2ff; --chip-text:#3949ab;
      --btn:#ff4d88; --btn-2:#5f7483;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f5f7fb; --card:rgba(255,255,255,0.96); --text:#14171a; --muted:#5b6776; }
    }
    html[data-theme="light"]{ color-scheme: light; }
    html[data-theme="dark"] { color-scheme: dark;  }

    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family:"Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 10% 0%, #141927 0%, var(--bg) 50%),
                  radial-gradient(1200px 800px at 90% 100%, #1b2133 0%, var(--bg) 50%);
      transition: background .4s ease, color .2s ease;
      min-height:100dvh;
    }

    #setup{
      margin:1.2rem auto; padding:1rem; max-width:760px; border-radius:14px;
      backdrop-filter: blur(6px);
      background: var(--card);
      border:1px solid rgba(255,255,255,.45);
      box-shadow: 0 10px 30px rgba(18,23,38,.18);
    }

    .title-wrapper{ display:flex; align-items:flex-end; justify-content:space-between; gap:1rem; }
    .title{
      font-family:"Outfit","Noto Sans JP",sans-serif; font-size:2.2rem; font-weight:800; margin:.2rem 0;
      background: linear-gradient(45deg, var(--accent), var(--accent-2));
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      letter-spacing:.5px;
    }

    .meta{ display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; color:var(--muted); margin:.4rem 0 .6rem; }
    .chip{
      display:inline-flex; align-items:center; gap:.4rem;
      background:var(--chip-bg); color:var(--chip-text);
      padding:.35rem .7rem; border-radius:999px; font-size:.9rem; font-weight:700;
    }

    .instruction{
      background:#e3f2fd; border-left:4px solid #42a5f5;
      padding:.6rem .8rem; border-radius:6px; margin:.6rem 0; font-size:.95rem;
    }

    label{ display:block; margin:.55rem 0; }
    input[type=number], select{ margin-left:.5rem; }

    .prob-setting{
      display:flex; align-items:center; gap:.5rem;
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.88));
      border:1px solid rgba(0,0,0,.06); border-radius:10px;
      padding:.5rem; margin-bottom:.5rem;
    }
    .prob-setting .rank-label{ width:3em; font-weight:800; }
    .prob-setting input[type=number]{ width:70px; }
    .prob-setting input[type=file]{ margin-left:.25rem; }
    .prob-setting .remove-btn{ margin-left:auto; cursor:pointer; color:#d00; font-size:1.1rem; }

    #countSum{ font-weight:800; margin:.5rem 0; }
    #countSum[aria-live]{ outline:none; }

    button{
      margin:4px; padding:10px 14px; border:none; border-radius:10px; cursor:pointer;
      background:var(--btn); color:#fff; font-weight:800;
      box-shadow:0 6px 16px rgba(255,77,136,.25);
      transition:transform .05s ease, box-shadow .2s ease, opacity .2s ease;
    }
    button:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(255,77,136,.28); }
    button:active{ transform:translateY(0); }
    button.secondary{ background:var(--btn-2); box-shadow:0 6px 16px rgba(95,116,131,.25); }
    button:disabled{ opacity:.6; cursor:default; transform:none; box-shadow:none; }

    .qr{
      position:absolute; width:100px; height:100px; cursor:pointer;
      image-rendering:pixelated; filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
      transition:opacity .45s ease;
    }
    .qr.fade-out{ opacity:0; }

    /* スキャンモード：読み取りやすく大きめ＆停止 */
    body.scan-mode .qr{ width:160px; height:160px; }

    canvas#confettiCanvas{ position:fixed; top:0; left:0; pointer-events:none; z-index:9999; }

    /* ログモーダル */
    #logModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); justify-content:center; align-items:center; z-index:10000; }
    #logModal[aria-hidden="false"]{ display:flex; }
    #logModal .modal-content{ background:#fff; padding:1rem; border-radius:10px; max-width:90%; max-height:80%; overflow:auto; }
    #logTable{ width:100%; border-collapse:collapse; margin-top:.5rem; }
    #logTable th,#logTable td{ border:1px solid #ddd; padding:8px; text-align:center; }

    footer{ position:fixed; bottom:0; left:0; width:100%; text-align:center; font-size:.65rem; color:#9aa3af; padding:6px 0; }

    /* 使い方パネル（details）をテーマ連動に */
    .howto{
      margin:.8rem 0;
      border:1px solid rgba(0,0,0,.08);
      border-radius:10px;
      background: var(--card);
    }
    html[data-theme="dark"] .howto{ border-color: rgba(255,255,255,.12); }
    .howto > summary::-webkit-details-marker{ display:none; }
    .howto > summary{
      cursor:pointer; list-style:none; padding:.8rem 1rem; font-weight:800;
      display:flex; align-items:center; gap:.5rem;
    }
    .howto > summary::before{
      content:"›"; display:inline-block; transform:rotate(0deg);
      transition: transform .2s ease;
      font-weight:900; font-size:1.1rem; color:var(--accent);
    }
    .howto[open] > summary::before{ transform:rotate(90deg); }
    .howto > div{ padding:.2rem 1rem 1rem 1rem; line-height:1.7; }
    .howto h4{ margin:.6rem 0 .3rem; font-size:1.05rem; }
  </style>
</head>

<body>
  <canvas id="confettiCanvas"></canvas>

  <!-- ログモーダル -->
  <div id="logModal" role="dialog" aria-modal="true" aria-labelledby="logModalTitle" aria-hidden="true" tabindex="-1">
    <div class="modal-content">
      <h2 id="logModalTitle">抽選ログ</h2>
      <table id="logTable">
        <thead><tr><th>等級</th><th>日時</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="text-align:right; margin-top:1rem;">
        <button id="exportCsvBtn" class="secondary">CSVダウンロード</button>
        <button id="closeLogBtn">閉じる</button>
      </div>
    </div>
  </div>

  <div id="setup">
    <div id="eventGate" style="display:none; margin:.8rem 0;">
  <div style="padding:1rem; border:1px solid #e5e7eb; border-radius:12px; background:var(--card);">
    <h3 style="margin:.2rem 0 1rem;">イベントを選択</h3>
    <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
      <button id="createEvBtn">🆕 新しいイベントを作成</button>
      <input id="joinEvInput" type="text" placeholder="既存IDを入力" style="flex:1; padding:.5rem;">
      <button id="joinEvBtn" class="secondary">参加</button>
    </div>
    <p style="font-size:.9rem; color:var(--muted); margin:.6rem 0 0;">
      作成すると、あなたの端末がそのイベントのオーナーになります。
    </p>
  </div>
</div>

<div class="title-wrapper">
      <h2 class="title">QRdeまとめて抽選</h2>
      <span class="chip" id="ownerBadge">状態: -</span>
    </div>

    <div class="meta">
      <span class="chip" id="eventBadge">イベントID: -</span>
      <button id="changeEventBtn" class="secondary">イベント切替</button>
      <button id="toggleScanBtn" class="secondary">スキャンモード</button>
      <button id="toggleThemeBtn" class="secondary">ダーク/ライト</button>
    </div>

    <details id="howto" class="howto">
      <summary>📘 使い方ガイド（クリックで開く）</summary>
      <div>
        <h4>主催者</h4>
        <ol style="margin:.2rem 0 0 1.2rem;">
          <li>左上の<strong>イベントID</strong>を確認（必要なら<strong>イベント切替</strong>）。</li>
          <li><strong>QRコード数</strong>と、等級ごとの<strong>枚数の合計</strong>を一致させる。</li>
          <li><strong>スタート</strong>でQRを表示。読み取りやすいよう<strong>スキャンモード</strong>で拡大可。</li>
          <li>読み取られたQRは<strong>フェードアウト</strong>。演出は紙吹雪で表示。</li>
          <li><strong>抽選ログ</strong>で履歴確認・<strong>CSVダウンロード</strong>が可能。</li>
          <li>次の回は<strong>リセット</strong>（オーナーのみ）。</li>
        </ol>

        <h4>参加者</h4>
        <ul style="margin:.2rem 0 0 1.2rem;">
          <li>スマホのカメラでQRを読み取るだけで抽選。</li>
          <li>同一端末（匿名UID）は<strong>1回のみ</strong>。2回目以降は「既に抽選済み」と表示。</li>
        </ul>

        <h4>ヒント / トラブル時</h4>
        <ul style="margin:.2rem 0 0 1.2rem;">
          <li><strong>スタートできない</strong>：合計＝QRコード数か確認。</li>
          <li><strong>リセットできない</strong>：オーナーのみ。必要なら「オーナーを引き継ぐ」を使用（イベントが空のとき）。</li>
          <li><strong>QRが読み取りにくい</strong>：スキャンモードで拡大／背景の明暗コントラストを強める。</li>
          <li><strong>更新が反映されない</strong>：キャッシュ削除・ハードリロード。</li>
          <li><strong>注意：</strong> PC（主催者画面）のQRはクリックしないでください。クリックすると抽選が実行されます。参加者のスマホで<strong>スキャンのみ</strong>を行ってください。</li>
        </ul>
      </div>
    </details>

    <div class="instruction">
      ※ 各等級(10等まで)の枚数の合計をQRコード数と一致させてスタート。<br>
      ※ スマホのカメラでQRを読み取るだけで抽選。<br>
      ※ 結果画像を選択しない場合はデフォルト画像となります。
    </div>

    <label for="qrTotal">QRコード数(50個まで):
      <input type="number" id="qrTotal" value="10" min="1" max="50" required>
    </label>

    <label for="bgmSelect">BGM選択:
      <select id="bgmSelect">
        <option value="off">オフ</option>
        <option value="pop">A</option>
        <option value="japan">B</option>
        <option value="fanfare">C</option>
      </select>
    </label>

    <div id="probSettings"></div>
    <button id="addProbBtn" class="secondary">等級を追加</button>

    <div id="countSum" aria-live="polite">
      合計枚数: <span id="currentSum">0</span> / <span id="totalQR">0</span>
    </div>

    <button id="startBtn" disabled>スタート</button>
    <button id="resetBtn">リセット</button>
    <button id="claimBtn" style="display:none" class="secondary">オーナーを引き継ぐ</button>
    <button id="showLogBtn" class="secondary">抽選ログを見る</button>
  </div>

  <!-- BGM -->
  <audio id="bgm_pop"     src="data/bgm_pop.mp3"     loop></audio>
  <audio id="bgm_japan"   src="data/bgm_japan.mp3"   loop></audio>
  <audio id="bgm_fanfare" src="data/bgm_fanfare.mp3" loop></audio>

  <script type="module">
    // ===== Firebase =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    // ★ Firebase 設定（scan.html と一致）
    const firebaseConfig = {
      apiKey: "AIzaSyAyLd3jvdVXikgOXrni3HwlDNUieeZAhH8",
      authDomain: "qryf-11545.firebaseapp.com",
      databaseURL: "https://qryf-11545-default-rtdb.firebaseio.com",
      projectId: "qryf-11545",
      storageBucket: "qryf-11545.appspot.com",
      messagingSenderId: "539005507453",
      appId: "1:539005507453:web:9faf1d69b175a50ce41e14"
    };

    // GitHub Pages のベースURL（scan.html 生成用）
    const BASE_URL = "https://tenapp76.github.io/my-web-app76/";

    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth();

    // ===== イベントIDの決定（?ev= / 保存 / 自動生成） =====
    const urlEv = new URLSearchParams(location.search).get('ev');
    let eventId = urlEv || localStorage.getItem('eventId') || ('ev-' + Math.random().toString(36).slice(2,8));
    localStorage.setItem('eventId', eventId);
    const ER = (p) => ref(db, `events/${eventId}/${p}`);

    // URLの ?ev を取得。無ければゲートを表示
const qp = new URLSearchParams(location.search);
let ev = qp.get('ev');

function randomEvId(){
  return 'ev-' + new Date().toISOString().slice(0,10).replace(/-/g,'') +
         '-' + Math.random().toString(36).slice(2,6);
}

function showEventGate(){
  const gate = document.getElementById('eventGate');
  gate.style.display = 'block';
  document.getElementById('createEvBtn').onclick = ()=>{
    const id = randomEvId();
    location.href = `${location.pathname}?ev=${encodeURIComponent(id)}`;
  };
  document.getElementById('joinEvBtn').onclick = ()=>{
    const id = (document.getElementById('joinEvInput').value || '').trim();
    if (!id) return alert('イベントIDを入力してください');
    location.href = `${location.pathname}?ev=${encodeURIComponent(id)}`;
  };
}

// ev が無ければゲートを出して処理を中断（以降の初期化は ev 前提）
// これに置き換え
if (!ev && !localStorage.getItem('eventId')) {
  showEventGate();
  // 初回は操作だけ無効化（UIは生成されるので「結果画像」も出る）
  document.getElementById('startBtn').disabled = true;
  document.getElementById('resetBtn').disabled = true;
}
  // ここで return しておくと、evが決まるまでゲームUIは動かない
  // 以降の Firebase 初期化や onValue 等を ev 以降にしている場合は return不要

// UI バッジ
    const eventBadge = document.getElementById('eventBadge');
    eventBadge.textContent = `イベントID: ${eventId}`;
    document.getElementById('changeEventBtn').addEventListener('click', ()=>{
      const ev = prompt('イベントIDを入力（新規可）', eventId) || eventId;
      if (ev !== eventId) {
        const url = new URL(location.href);
        url.searchParams.set('ev', ev);
        location.href = url.toString();
      }
    });

    // ===== 認証（匿名） =====
    let uid = null;       // 自分のUID
    let ownerUid = null;  // /events/<ev>/config/ownerUid
    let hasDrawn = false; // 自分が抽選済みか
    const sessionId = Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,8);

    function updateOwnerUI(){
      const resetBtn = document.getElementById('resetBtn');
      const isOwner = !!uid && !!ownerUid && uid === ownerUid;
      if (resetBtn) {
        resetBtn.disabled = !isOwner;
        resetBtn.title = isOwner ? "" : "リセットはオーナーのみ可能です";
      }
      const badge = document.getElementById('ownerBadge');
      badge.textContent = isOwner
        ? `🛠 オーナー: この端末（${(uid||'').slice(0,6)}…）`
        : `👤 オーナーではありません（owner: ${(ownerUid||'未設定').toString().slice(0,6)}…）`;
    }

    // DBが空なら“引き継ぎ”ボタン表示
    const empty = { scans:true, users:true };
    const claimBtn = document.getElementById('claimBtn');
    const toggleClaimBtn = ()=>{
      const canClaim = !!uid && empty.scans && empty.users;
      claimBtn.style.display = canClaim ? 'inline-block' : 'none';
    };

    onValue(ER('scans'), s => { empty.scans = !s.exists(); toggleClaimBtn(); });
    onValue(ER('users'), s => { empty.users = !s.exists(); toggleClaimBtn(); });
    onValue(ER('config/ownerUid'), s => { ownerUid = s.val(); updateOwnerUI(); toggleClaimBtn(); });

    claimBtn.addEventListener('click', async ()=>{
      try { await set(ER('config/ownerUid'), uid); alert('この端末をオーナーに設定しました'); }
      catch(e){ alert('オーナー引き継ぎに失敗: ' + (e.code || e.message)); }
    });

    setPersistence(auth, browserLocalPersistence)
      .then(() => signInAnonymously(auth))
      .catch(e => console.warn("匿名認証に失敗:", e));

    onAuthStateChanged(auth, (user) => {
      if (!user) return;
      uid = user.uid;
      onValue(ER(`users/${uid}`), snap => { hasDrawn = !!snap.val(); });
      updateOwnerUI();
    });

    // ===== テーマ & スキャンモード =====
    const toggleScanBtn  = document.getElementById('toggleScanBtn');
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');
    let scanMode = false;

    function setTheme(mode){
      document.documentElement.dataset.theme = mode;
      localStorage.setItem('theme', mode);
      toggleThemeBtn.textContent = (mode === 'dark') ? 'ライト' : 'ダーク';
    }
    setTheme(localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

    toggleThemeBtn.addEventListener('click', ()=>{
      const cur = document.documentElement.dataset.theme || 'light';
      setTheme(cur === 'dark' ? 'light' : 'dark');
    });

    toggleScanBtn.addEventListener('click', ()=>{
      scanMode = !scanMode;
      document.body.classList.toggle('scan-mode', scanMode);
      toggleScanBtn.textContent = scanMode ? '通常モード' : 'スキャンモード';
    });

    window.addEventListener('keydown', (e)=>{
      if (e.key.toLowerCase() === 's') toggleScanBtn.click();
      if (e.key.toLowerCase() === 't') toggleThemeBtn.click();
    });

    // ===== キャンバス & 紙吹雪 =====
    const canvas = document.getElementById('confettiCanvas');
    const ctx    = canvas.getContext('2d');
    function fitCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    fitCanvas(); window.addEventListener('resize', fitCanvas);

    let confetti = []; let qrData = [], qrElements = []; let animationFrame;

    function launchConfetti(x, y) {
      for (let i = 0; i < 40; i++) {
        confetti.push({ x, y, vx:(Math.random()-0.5)*6, vy:(Math.random()-1.2)*6, size:Math.random()*6+4, rot:Math.random()*Math.PI, vr:(Math.random()-0.5)*0.2, life:70 });
      }
    }
    function stepConfetti(){
      for (let i = confetti.length - 1; i >= 0; i--) {
        const p = confetti[i];
        p.vy += 0.08; p.x += p.vx; p.y += p.vy; p.rot += p.vr; p.life--;
        if (p.life <= 0 || p.y > canvas.height + 40) confetti.splice(i,1);
      }
    }
    function drawConfetti(){
      ctx.save();
      for (const p of confetti){ ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.globalAlpha = Math.max(0, p.life/70); ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); ctx.setTransform(1,0,0,1,0,0); }
      ctx.restore(); ctx.globalAlpha = 1;
    }

    // スキャン状態のリッスン（他端末で読み込まれたQRを即時消す）
    onValue(ER('scans'), snapshot => {
      const scans = snapshot.val() || {};
      qrElements.forEach(qr => {
        if (scans[qr.id]) {
          const el = document.querySelector(`img.qr[data-qr-id="${qr.id}"]`);
          if (el) {
            el.classList.add('fade-out');
            const rect = el.getBoundingClientRect();
            launchConfetti(rect.left + rect.width/2, rect.top + rect.height/2);
            setTimeout(() => qr.destroy(), 450);
          } else {
            qr.destroy();
          }
        }
      });
    });

    // ===== ユーティリティ =====
    const $  = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const absUrl = (p) => new URL(p, location.href).href;

    function imageToBase64(file) {
      return new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload  = ()=>res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
    }

    function updateSum() {
      const totalQR = +$('#qrTotal').value;
      const sum = $$('#probSettings input[name="count"]').map(i=>+i.value).reduce((a,b)=>a+b,0);
      $('#currentSum').textContent = sum; $('#totalQR').textContent = totalQR;
      $('#startBtn').disabled = (sum !== totalQR);
    }

    function addProb() {
      const cont = $('#probSettings');
      const cnt  = cont.children.length;
      if (cnt >= 10) { alert('等級は最大10までです'); return; }
      const rank = cnt + 1;
      const div  = document.createElement('div');
      div.className = 'prob-setting';
      div.innerHTML = `
        <span class="rank-label">${rank}等</span>
        枚数: <input name="count" type="number" value="1" min="1"> 枚
        結果画像: <input name="resultImage" type="file" accept="image/*">
        ${rank>1?`<span class="remove-btn" role="button" tabindex="0">✖</span>`:``}
      `;
      cont.appendChild(div);
      const countInput = div.querySelector('input[name="count"]');
      countInput.addEventListener('input', updateSum);
      if (rank>1) {
        const btn = div.querySelector('.remove-btn');
        btn.addEventListener('click', ()=>removeProb(btn));
        btn.addEventListener('keydown', e=>{ if (e.key==='Enter'||e.key===' ') removeProb(btn); });
      }
      updateSum();
    }

    function removeProb(btn) {
      btn.closest('.prob-setting').remove();
      $$('#probSettings .prob-setting').forEach((div,i)=>{ div.querySelector('.rank-label').textContent = (i+1)+'等'; });
      updateSum();
    }

    async function generateQRData() {
      const total = +$('#qrTotal').value;
      const groups = $$('#probSettings .prob-setting');
      const counts = groups.map(div => +div.querySelector('input[name="count"]').value);
      const sum = counts.reduce((a, b) => a + b, 0);
      if (sum !== total) throw new Error('合計枚数が QRコード数と一致していません');

      const data = [];
      let id = 1;
      for (let i = 0; i < groups.length; i++) {
        const cnt = counts[i];
        const fi = groups[i].querySelector('input[name="resultImage"]');
        const defaultImg = `images/default_${i+1}.png`;
        const resultImg = fi.files[0] ? await imageToBase64(fi.files[0]) : defaultImg;

        for (let j = 0; j < cnt; j++) {
          const qrId = `${sessionId}-qr${id++}`;
          const rank = `${i+1}等`;

          const handlerURL = new URL('scan.html', location.href);
          handlerURL.searchParams.set('id', qrId);
          handlerURL.searchParams.set('rank', rank);
          handlerURL.searchParams.set('ev', eventId);   // イベントID
          handlerURL.searchParams.set('v', '5');

          const qrcodeImage = await new Promise((resolve, reject) => {
            QRCode.toDataURL(
              handlerURL.href,
              { width: 256, margin: 2, errorCorrectionLevel: 'M' },
              (err, url) => err ? reject(err) : resolve(url)
            );
          });

          data.push({ id: qrId, image: qrcodeImage, resultImage: resultImg, rank });
        }
      }
      return { data };
    }

    class QR {
      constructor(d) {
        this.d = d; this.id = d.id; this.w = 100; this.h = 100;
        this.x = Math.random()*Math.max(1,canvas.width  - this.w);
        this.y = Math.random()*Math.max(1,canvas.height - this.h);
        this.vx= (Math.random()*3-1.5) || 1;
        this.vy= (Math.random()*3-1.5) || -1;
        this.el=document.createElement('img');
        this.el.src=d.image; this.el.className='qr'; this.el.dataset.qrId=d.id;
        this.el.style.left=this.x+'px'; this.el.style.top=this.y+'px';
        this.el.addEventListener('load', ()=>{
          const r = this.el.getBoundingClientRect();
          if (r.width && r.height){ this.w = r.width; this.h = r.height; }
        });
        this.el.addEventListener('click', ()=>this.click());
        this.el.addEventListener('pointerdown', ()=>this.click());
        document.body.appendChild(this.el);
      }
      move(){
        this.x += this.vx; this.y += this.vy;
        if (this.x < 0) { this.x = 0; this.vx *= -1; }
        if (this.y < 0) { this.y = 0; this.vy *= -1; }
        if (this.x > canvas.width  - this.w) { this.x = canvas.width  - this.w; this.vx *= -1; }
        if (this.y > canvas.height - this.h){ this.y = canvas.height - this.h; this.vy *= -1; }
        this.el.style.left = this.x + 'px'; this.el.style.top  = this.y + 'px';
      }
      async click(){
        if (!uid)  { alert('接続中…数秒後にお試しください'); return; }
        if (hasDrawn) { alert('🎉 抽選済みです 🎉'); return; }
        const now = Date.now();
        const { id:qrId, rank } = this.d;
        try {
          await set(ER(`scans/${qrId}`), { uid, timestamp: now });
          await set(ER(`users/${uid}`), { drawnAt: now, qrId, rank });
          hasDrawn = true; // 即時ガード
          this.destroy();
          logDraw(rank);
          localStorage.setItem('lastResultImage', this.d.resultImage);
          localStorage.setItem('lastRank', rank);
          const resultURL = absUrl(`result/${encodeURIComponent(rank)}.html`);
          window.open(resultURL, '_blank', 'noopener');
        } catch(e) {
          alert('🎉 抽選済みです 🎉');
          console.warn(e);
        }
      }
      destroy(){ this.el.remove(); }
    }

    function animate(){
      if (!scanMode) { qrElements.forEach(q=>q.move()); } // スキャンモード時は停止
      ctx.clearRect(0,0,canvas.width,canvas.height);
      stepConfetti(); drawConfetti();
      animationFrame = requestAnimationFrame(animate);
    }

    async function startGame(){
      document.getElementById('addProbBtn').disabled=true;
      document.body.classList.add('playing'); // 背景は固定（CSSで変更しない）
      const bgm=document.getElementById('bgmSelect').value;
      if (bgm!=='off') document.getElementById('bgm_'+bgm).play();
      try {
        const { data } = await generateQRData();
        qrData = data;
        qrElements = qrData.map(d=>new QR(d));
        document.getElementById('startBtn').disabled=true;
        animate();
      } catch(e) {
        alert(e.message);
        resetGame();
      }
    }

    async function resetGame(){
      // オーナーでなければ、まず引き継ぎ（空なら成功）
      if (uid !== ownerUid) {
        try { await set(ER('config/ownerUid'), uid); ownerUid = uid; updateOwnerUI(); } catch(_){}
        if (uid !== ownerUid) { alert("リセットはオーナーのみ可能です"); return; }
      }

      try { await remove(ER('scans')); } catch(e) { console.warn('scans削除失敗:', e); }
      try { await remove(ER('users')); } catch(e) { console.warn('users削除失敗:', e); }
      try { await set(ER('config/ownerUid'), uid); } catch(_){}

      cancelAnimationFrame(animationFrame);
      qrElements.forEach(q=>q.destroy());
      qrElements=[]; qrData=[]; confetti=[];

      ['bgm_pop','bgm_japan','bgm_fanfare'].forEach(id=>{ const a=document.getElementById(id); a.pause(); a.currentTime=0; });
      document.getElementById('addProbBtn').disabled=false;
      document.getElementById('startBtn').disabled=false;
      document.body.classList.remove('playing');
    }

    function logDraw(rank){
      const logs = JSON.parse(localStorage.getItem('qrLogs')||'[]');
      logs.push({ rank, time:new Date().toLocaleString() });
      localStorage.setItem('qrLogs', JSON.stringify(logs));
    }

    function showLog(){
      const m=document.getElementById('logModal');
      const logs=JSON.parse(localStorage.getItem('qrLogs')||'[]');
      const tb=m.querySelector('tbody');
      tb.innerHTML = '';
      if (!logs.length) {
        tb.innerHTML = '<tr><td colspan="2">履歴がありません</td></tr>';
      } else {
        logs.forEach(l=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${l.rank}</td><td>${l.time}</td>`;
          tb.appendChild(tr);
        });
      }
      m.setAttribute('aria-hidden','false');
      m.focus(); trapFocus(m);
    }

    function closeLog(){
      const m=document.getElementById('logModal');
      m.setAttribute('aria-hidden','true');
      document.getElementById('showLogBtn').focus();
    }

    function trapFocus(modal){
      const els=modal.querySelectorAll('button,[tabindex]:not([tabindex="-1"])');
      const first=els[0], last=els[els.length-1];
      modal.onkeydown=e=>{
        if (e.key==='Escape') return closeLog();
        if (e.key==='Tab'){
          if (e.shiftKey&&document.activeElement===first){ e.preventDefault(); last.focus(); }
          else if (!e.shiftKey&&document.activeElement===last){ e.preventDefault(); first.focus(); }
        }
      };
    }

    function downloadCsv(){
      const logs=JSON.parse(localStorage.getItem('qrLogs')||'[]');
      if (!logs.length) return alert('履歴なし');
      const rows=[['等級','日時'], ...logs.map(l=>[l.rank,l.time])];
      const csv=rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\r\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='qr_logs.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // ===== init =====
    window.addEventListener('load', ()=>{
      updateOwnerUI(); // ← これを最初に1回
      addProb(); updateSum();
      // 初期テーマ
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) document.documentElement.dataset.theme = savedTheme;

      addProb(); updateSum();
      document.getElementById('qrTotal').addEventListener('input', updateSum);
      document.getElementById('addProbBtn').addEventListener('click', addProb);
      document.getElementById('startBtn').addEventListener('click', startGame);
      document.getElementById('resetBtn').addEventListener('click', resetGame);
      document.getElementById('showLogBtn').addEventListener('click', showLog);
      document.getElementById('closeLogBtn').addEventListener('click', closeLog);
      document.getElementById('exportCsvBtn').addEventListener('click', downloadCsv);
    });
  </script>

  <footer>QRコードは株式会社デンソーウェーブの登録商標です ／
    <span class="legal-note">本アプリの利用により生じたいかなる損害についても、開発者は責任を負いません。イベントでの利用前に必ず動作確認を行ってください。</span>
  <br>
  <small class="about-note">補足：AIを活用して作成した実験的ツールです。</small>
  </footer>
</body>
</html>
